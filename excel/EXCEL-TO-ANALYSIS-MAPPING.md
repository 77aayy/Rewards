# ربط ملفات Excel السبعة بصفحة التحليل

هذا الملف يوضح **أي من الـ 7 ملفات** يُستخدم لأي بيانات في صفحة التحليل، وكيف تتحقق أن الاستخراج **دقيق 100%**.

---

## 1. الملفات السبعة والاستخدام

| # | اسم الملف (تقريبي) | النوع في التطبيق | الغرض |
|---|---------------------|------------------|--------|
| 1 | **UserStatisticsReport_Ar.xlsx** | **staff** | **المرجع:** عدد الحجوزات الإجمالي لكل موظف (وفق الفرع). يُستخرج من عمود "عدد الحجوزات" أو "الحجوزات" + "اسم الموظف/الموظف". |
| 2 | **GuestsStatistical_Ar.xlsx** | **report** (فرع 1) | **التوزيع:** كل صف = حجز. منه يُستخرج: استقبال/بوكينج (مصدر الحجز)، صباح/مساء/ليل (من تاريخ/وقت الإنشاء). |
| 3 | **GuestsStatistical_Ar (1).xlsx** | **report** (فرع 2) | نفس الاستخدام لفرع ثانٍ. |
| 4 | **ResesrvationsUnits_ar.xlsx** | **units** (فرع 1) | وحدات الحجوزات: إيجار، ليالي، رقم الوحدة، نوع الوحدة — تُستخدم للتسعير والتحقق. |
| 5 | **ResesrvationsUnits_ar (1).xlsx** | **units** (فرع 2) | نفس الاستخدام لفرع ثانٍ. |
| 6 | **ActivityLog_en.xlsx** | **log** (فرع 1) | سجل الحركات: يُستخدم لاكتشاف نقل الغرفة (room transfer) واستبعاد تنبيه التسعير. |
| 7 | **ActivityLog_en (1).xlsx** | **log** (فرع 2) | نفس الاستخدام لفرع ثانٍ. |

---

## 2. من أين تأتي الأرقام في الجدول

- **المرجع** = من ملف **staff** فقط: مجموع عمود "عدد الحجوزات" (أو "الحجوزات") لكل موظف-فرع.
- **استقبال + بوكينج** = من ملفات **report**: كل صف حجز فيه عمود "مصدر الحجز" → تصنيف "استقبال" أو "بوكينج". المجموع (بعد الفلترة حسب الفترة) قد يكون أقل من المرجع إذا التقرير ناقص؛ عندها التطبيق يوزع تناسبياً حتى **استقبال + بوكينج = المرجع**.
- **صباح + مساء + ليل** = من ملفات **report**: عمود "تاريخ/وقت الإنشاء" يُحول إلى وقت، ثم:
  - **صباح:** 6:00–16:00  
  - **مساء:** 16:00–24:00  
  - **ليل:** 0:00–6:00  
  نفس التوزيع التناسبي يُطبّق إذا المجموع المحسوب ≠ المرجع.
- **VIP (601, 602, …)** = من **report** أيضاً: عمود رقم الوحدة/الوحدة يُصنّف حسب القواعد (VIP / عادي).
- **تنبيهات / نقص SAR** = من منطق التسعير (الحد الأدنى للسعر، وحدات، نقل الغرفة، إلخ).

---

## 3. التحقق من دقة 100%

1. **المرجع:**  
   في ملف **UserStatisticsReport_Ar.xlsx** عدّ يدوياً (أو بمعادلة) "عدد الحجوزات" للموظف X في الفرع Y. يجب أن يساوي قيمة "المرجع" لـ X في نفس الفرع في صفحة التحليل.

2. **استقبال / بوكينج:**  
   في ملف **GuestsStatistical_Ar** (الفرع المناسب): فلتر حسب الموظف والفترة، ثم عد الصفوف التي عمود "مصدر الحجز" = استقبال، وعد التي = بوكينج. يجب أن تطابق (أو أن يكون الفرق مفسراً بالفلترة الزمنية) ما يظهر في التحليل قبل/بعد التوزيع التناسبي.

3. **صباح / مساء / ليل:**  
   نفس ملف **GuestsStatistical_Ar**: عمود "تاريخ/وقت الإنشاء" بصيغة تحتوي وقت (مثل `DD/MM/YYYY, HH:MM AM/PM`). التطبيق يتعرف عليها بدالة `parseDateTime`. عد الصفوف التي وقت الإنشاء يقع في كل شفت. النتائج يجب أن تطابق أعمدة الشفتات في التحليل (أو التوزيع التناسبي عند النقص).

4. **تطابق الأسماء:**  
   أسماء الموظفين في **staff** و **report** يجب أن تكون متطابقة (نفس النص/التطبيع). أي اختلاف يسبب عدم ربط الصفوف بالمرجع.

5. **الفترة الزمنية:**  
   في صفحة التحليل، الفترة المختارة تُطبق على:
   - تاريخ الإنشاء
   - تاريخ الدخول  
   فقط الصفوف التي تحقق الشرطين تدخل في العد. لو الملف يحتوي حجوزات خارج الفترة، ستكون الأرقام في التقرير أكبر من الجدول — وهذا متوقع.

---

## 4. أعمدة مهمة في الكود (للرجوع)

- **Staff:** `STAFF_HEADER_ALIASES` في `app/src/parser.ts`:  
  `bookingCount`: ['عدد الحجوزات', 'الحجوزات'],  
  `employeeName`: ['اسم الموظف', 'الموظف', 'المستخدم'].

- **Report:** `REPORT_HEADER_ALIASES`:  
  `creationTime`: ['تاريخ/وقت الإنشاء', 'تاريخ الإنشاء', ...],  
  `bookingSource`: ['مصدر الحجز', 'المصدر'],  
  `employeeName`, `bookingNumber`, `roomUnit`, `guestName`, إلخ.

- **الشفت:** `getShiftFromTime`: دقائق من منتصف الليل: صباح 360–959، مساء 960–1439، ليل 0–359 أو 1440+.

- **تحديد نوع الملف:** `detectFileType()` يربط اسم الورقة أو محتوى الصفوف بـ `staff` / `report` / `units` / `log` (انظر نفس الملف).

---

## 5. خلاصة

- **المرجع** من ملف **واحد (staff)**.  
- **التوزيع (استقبال، بوكينج، صباح، مساء، ليل)** من ملفات **report**؛ إذا كان المجموع المحسوب ≠ المرجع، التطبيق يوزع تناسبياً حتى المجموع = المرجع.  
- الـ **7 ملفات** = 1 staff + 2 report + 2 units + 2 log.  
للتحقق من دقة 100%: قارن الأعمدة المذكورة أعلاه في الإكسيل مع ما يظهر في صفحة التحليل لنفس الموظف والفرع والفترة.
