# اقتراحات تحسين الأداء — مشروع e-Rewards

نتيجة فحص المشروع بالكامل.

---

## 1. تطبيق React (`app/src/`)

### الوضع الحالي
- `App.tsx` كبير جداً (~3,600 سطر) — كل المنطق والمكوّنات في ملف واحد
- استخدام جيد لـ `useMemo` و `useCallback` (~40+ موضع)
- لا يوجد `React.lazy` أو `Suspense` — كل الحزم تُحمّل مع أول تحميل
- استيراد ثابت لكل الحزم: Firebase، xlsx، react-table، lucide-react

### نقاط ضعف
| المشكلة | التأثير |
|---------|---------|
| تحميل xlsx (حجم كبير) حتى بدون رفع ملفات | بطء التحميل الأولي |
| عدم استخدام `React.memo` للمكوّنات الثقيلة | إعادة رسم غير ضرورية |
| استيراد كل أيقونات Lucide مرة واحدة | زيادة حجم الـ bundle |

### اقتراحات (مرتبة حسب الأثر)

| الأولوية | الاقتراح | الجهد |
|----------|----------|-------|
| **عالي** | استخدام `React.lazy` لمكوّنات الشاشات الكبيرة (جدول الملخص، لوحة الإعدادات، النماذج المنبثقة) | متوسط |
| **عالي** | تحميل xlsx عند الحاجة: `import('xlsx')` عند الضغط على "رفع ملفات" أو عند سحب الملفات | منخفض |
| **متوسط** | إضافة `React.memo` لمكوّنات مثل صفوف الجدول وEmployeeBreakdown | متوسط |
| **متوسط** | تقسيم App.tsx إلى مكوّنات أصغر (AnalysisView، TableView، SettingsPanel) | عالي |
| **منخفض** | التأكد من استيراد أيقونات Lucide بشكل tree-shakeable (الوارد الحالي صحيح) | — |

---

## 2. إعداد Vite والبناء

### الوضع الحالي
- `manualChunks` يفصل: firebase، xlsx، react-table
- لا يوجد chunk منفصل لـ React
- لا `reportCompressedSize` لتحليل الحجم بعد الضغط

### اقتراحات

| الأولوية | الاقتراح | الجهد |
|----------|----------|-------|
| **متوسط** | إضافة chunk لـ React: `if (id.includes('node_modules/react') || id.includes('react-dom')) return 'vendor-react'` | منخفض |
| **متوسط** | تفعيل `build.reportCompressedSize: true` لقياس الأحجام المضغوطة | منخفض |
| **منخفض** | `build.chunkSizeWarningLimit: 600` إذا ظهرت تحذيرات | منخفض |

---

## 3. Firebase

### الوضع الحالي
- **Polling:** الموظفون كل 15 ثانية، الأدمن كل 12 ثانية
- **visibilitychange:** يوجد listener لكنه يفعّل `poll()` عند العودة للتبويب فقط — **لا يوقف الـ polling عند إخفاء التبويب**
- **saveAdminTokens:** يُستدعى كثيراً مع `setTimeout` متعددة (2s, 5s, 1.5s, 4s) — احتمال عمليات حفظ مكررة لـ Storage

### اقتراحات

| الأولوية | الاقتراح | الجهد |
|----------|----------|-------|
| **عالي** | إيقاف الـ polling عند `visibilityState === 'hidden'` وإعادة التشغيل عند `visible` | منخفض |
| **عالي** | دمج `saveAdminTokens` في تنفيذ واحد debounced (مثلاً 500ms) | متوسط |
| **متوسط** | الاعتماد على `lastModified` وعدم إعادة الجلب إذا لم تتغيّر البيانات | متوسط |
| **متوسط** | زيادة الفاصل للموظفين إلى 30 ثانية | منخفض |
| **منخفض** | استخدام Firebase Modular SDK في React لتحسين tree-shaking | عالي |

---

## 4. تطبيق Rewards (Vanilla JS)

### الوضع الحالي
- **السكربتات:** 8+ سكربتات في `<head>` بدون `defer`
- **SheetJS:** يُحمّل مع الصفحة (~1MB+) رغم أنه يُستخدم عند رفع ملف Excel فقط
- **html2pdf:** يُحمّل مع الصفحة رغم أنه يُستخدم عند الطباعة فقط
- **RENDER_CHUNK_SIZE = 14** — رسم تدريجي للجدول (إيجابي)

### نقاط ضعف
| المشكلة | التأثير |
|---------|---------|
| تحميل متسلسل لكل السكربتات | إعاقة First Contentful Paint |
| SheetJS + html2pdf من البداية | تحميل أولي ثقيل |

### اقتراحات

| الأولوية | الاقتراح | الجهد |
|----------|----------|-------|
| **عالي** | إضافة `defer` لكل السكربتات غير الحرجة (SheetJS، html2pdf، qrcode، إلخ) | منخفض |
| **عالي** | تحميل SheetJS ديناميكياً: `await import('https://cdn.sheetjs.com/...')` عند فتح واجهة الرفع أو اختيار ملف | متوسط |
| **عالي** | تحميل html2pdf ديناميكياً عند أول طلب طباعة PDF | منخفض |
| **متوسط** | رفع `RENDER_CHUNK_SIZE` إلى ~30–50 مع مراقبة الأداء | منخفض |
| **منخفض** | virtualization للجدول عند >200 صف | عالي |

---

## 5. الأصول (الصور، الخطوط)

### الوضع الحالي
- **الخط:** IBM Plex Sans Arabic — 7 أوزان (300–900)
- **رابط الخط:** `display=swap` موجود بالفعل في الرابط
- **preconnect:** موجود لـ Firebase في Rewards؛ لا يوجد لـ Google Fonts

### اقتراحات

| الأولوية | الاقتراح | الجهد |
|----------|----------|-------|
| **عالي** | إضافة `preconnect` لـ `fonts.googleapis.com` و `fonts.gstatic.com` في كل الصفحات | منخفض |
| **متوسط** | تقليل أوزان الخط إلى المستخدمة فقط (مثلاً 400, 600, 700) بدلاً من 300–900 | منخفض |
| **منخفض** | ضغط الصور (icon-192, icon-512, unnamed) وتحويلها لـ WebP مع fallback | منخفض |

---

## 6. ملخص تنفيذي

### أولوية عالية (تأثير واضح، جهد معقول)
1. إيقاف Firebase polling عند إخفاء التبويب
2. إضافة `defer` للسكربتات غير الحرجة في صفحة Rewards
3. تحميل SheetJS و html2pdf عند الطلب في Rewards
4. تحميل xlsx عند الطلب في React
5. إضافة `preconnect` لـ Google Fonts
6. دمج `saveAdminTokens` في تنفيذ debounced

### أولوية متوسطة
7. استخدام `React.lazy` للمكوّنات الكبيرة
8. إضافة `React.memo` للمكوّنات الثقيلة
9. تحسين manualChunks في Vite (chunk لـ React)
10. رفع `RENDER_CHUNK_SIZE` في الجدول

### أولوية منخفضة
11. تقسيم App.tsx إلى مكوّنات أصغر
12. virtualization للجدول الكبير جداً
13. تحسين تنسيقات الصور (WebP)

---

*هذا المستند لا يغيّر المعادلات ولا المنطق الحسابي.*
