# برومبت التنفيذ — تنفيذ إصلاحات تقرير المراجعة

**المطلوب:** تنفيذ الإصلاحات التالية **في الكود والملفات** (تعديلات فعلية، مش تقرير جديد). البنود 1–5 إصلاحات أساسية؛ البنود 6–9 **إصلاحات كبيرة** (فصل app.js، استبدال/تأمين xlsx، توحيد مسح الجلسة، سكربت تحقق النشر) — كلها مطلوبة ضمن نطاق العمل. كل بند ينتهي بملف/كود معدّل وليس بملخص أو توصية فقط.

---

## قواعد إلزامية (لا تُخالفها)

1. **اتبع البنود من 1 إلى 9 بالترتيب.** لا تتخطى بنداً ولا تترك واحداً "لاحقاً". البنود 6–9 إصلاحات كبيرة (فصل app.js، xlsx، مسح الجلسة، سكربت تحقق النشر) — مطلوبة لأن التسليم يشمل تحسينات فعلية وليس تقارير فقط. كل بند له معيار إنجاز — تحققه قبل ما تنتقل للتالي.

2. **تنفيذ فعلي فقط.** المطلوب تعديلات في الكود والملفات (إنشاء/تعديل ملفات، سكربتات، توثيق). لا تكتب "تم التوصية" أو تقريراً بديلاً — المطلوب كود وملفات معدّلة.

3. **التوثيق مضبوط ومرتب.** أي ملف توثيق تضيفه أو تعدّله (بما فيها DELIVERY-AND-AUDIT.md و CODE_REVIEW_REPORT.md):
   - عناوين واضحة، أرقام بنود إن لزم.
   - مسارات الملفات وأسماء الدوال مطابقة للكود الفعلي (لا أخطاء أرقام أسطر أو أسماء دوال).
   - لغة عربية سليمة وبدون اختصارات غامضة.

4. **لا تخالف معمارية المشروع ولا الأمان.** راجع `app/Rewards/SECURITY.md` و `app/Rewards/ARCHITECTURE.md` قبل تنفيذ أي تغيير يمس الصلاحيات أو Firebase أو المفتاح. لا تضع أسراراً في الكود؛ لا تفتح صلاحيات أو قواعد Storage بدون توثيق السبب. مصدر المكافآت يبقى `app/Rewards/` — أي تعديل للمكافآت يكون هناك ثم `npm run sync:rewards`.

5. **التحقق بعد التعديل.** بعد كل بند (أو في النهاية): شغّل `npm run build` و `npm run sync:rewards` من مجلد `app` وتأكد أن البناء ينجح. إن وُجدت أخطاء TypeScript أو ESLint في الملفات اللي عدّلتها أصلحها قبل التسليم.

6. **DELIVERY-AND-AUDIT.md (أو TANFIZ-DONE) إلزامي.** بدون ملف يوثّق ما تم تنفيذه فعلياً وما لم يُنفَّذ (وفق البند 5) التسليم غير مكتمل.

7. **لا تخمين.** لو شيء غير واضح (مسار ملف، اسم دالة، سلوك مطلوب) راجع الكود أو الوثائق (CODE_REVIEW_REPORT، SECURITY، ARCHITECTURE) أو اسأل صاحب المشروع. لا تنفّذ حاجة على أساس تخمين.

---

**المرجع:** `app/docs/CODE_REVIEW_REPORT.md` — التقرير اللي اتكتب بعد المراجعة. المطلوب الآن **تنفيذ** التوصيات القابلة للتنفيذ تقنياً.

---

## 1. توحيد إعداد Firebase (مصدر واحد)

**المشكلة:** إعداد Firebase مكرر في 5 ملفات. أي تعديل يحتاج تحديث يدوي في كل المواضع.

**المطلوب تنفيذه:**

1. إنشاء ملف **مصدر واحد** للإعداد في المشروع، بحيث باقي الملفات تقرأ منه أو يُحقن منه عند البناء.
   - **الخيار أ:** ملف `app/shared/firebase-config.json` (أو `.js` يصدّر object) يُقرأ من سكربت بناء ويُحقن في `adminConfig.ts` و `firebase.ts` و `Rewards/src/firebase-config.js` و `clear-session.html` عبر سكربت (مثلاً في `scripts/` ينسخ القيم أو يولد الملفات).
   - **الخيار ب:** ملف `app/scripts/firebase-config.source.js` يصدر القيم؛ سكربت في `prepare-deploy` أو في البناء يقرأه ويكتب القيم في `Rewards/public/` و `clear-session.html`؛ و `adminConfig.ts` و `firebase.ts` يستوردان من ملف مشترك إن أمكن أو يقرآن من نفس المصدر عند البناء.
2. بعد التنفيذ: أي تغيير في إعداد Firebase يتم في **مكان واحد** فقط، وباقي الملفات تُحدَّث تلقائياً (عبر سكربت أو import).

**معيار الإنجاز:** تغييرك قيمة واحدة (مثلاً apiKey) في مكان واحد فقط، ثم تشغيل البناء/السكربت، وتتحقق أن كل الملفات (adminConfig، firebase.ts، clear-session، rewards firebase-config) تحتوي القيمة الجديدة بدون تعديل يدوي في 5 ملفات.

---

## 2. تقييد مدخلات رفع الملفات (تقليل خطر xlsx)

**المشكلة:** حزمة xlsx بها ثغرات (Prototype Pollution، ReDoS). التقرير يوصي بتقييم بدائل أو تقييد مدخلات الملفات.

**المطلوب تنفيذه:**

1. في مكان رفع ملفات الإكسل (التطبيق الرئيسي — التحليل): إضافة تحقق صريح قبل تمرير الملف لـ xlsx:
   - **حجم الملف:** حد أقصى (مثلاً 10MB أو 15MB) — رفض الملف إذا زاد.
   - **نوع الملف:** التحقق من أن الـ file type هو تطبيق معروف (مثلاً `application/vnd.openxmlformats-officedocument.spreadsheetml.sheet` أو امتداد `.xlsx`/`.xls`) ورفض أي نوع غير متوقع.
2. عدم فتح/تحليل الملف إذا فشل التحقق، مع رسالة واضحة للمستخدم (مثلاً: "حجم الملف يتجاوز الحد المسموح" أو "نوع الملف غير مدعوم").
3. (اختياري) توثيق في التعليقات أو في README أن استبدال xlsx ببديل رسمي (مثلاً SheetJS الرسمي) يُفضّل لاحقاً؛ مع الإبقاء على تقييد المدخلات كإجراء فوري.

**معيار الإنجاز:** رفع ملف أكبر من الحد أو بامتداد غير مدعوم يُرفض ولا يصل لـ xlsx، مع رسالة للمستخدم.

---

## 3. تحديث التقرير (دقة النص فقط)

**المطلوب تنفيذه في ملف `app/docs/CODE_REVIEW_REPORT.md`:**

1. في القسم 6.2 (التحليل → نقل للمكافآت): استبدال العبارة التي تذكر "يُبنى من `buildTransferPayload`" بـ **"يُبنى داخل `handleTransferToRewards`"** (لأن الدالة الفعلية في الكود هي handleTransferToRewards والـ payload يُجمّع داخلها).
2. في الجدول (قسم 2) وفي قسم 3.1: تحديث أرقام الأسطر لـ adminConfig — المفتاح حالياً في **سطر 11** والإيميلات في **سطور 12–15** (بعد وجود دالة env). تصحيح "س6–7" إلى "س11، 12–15" أو ما يطابق الملف الحالي.
3. تصحيح ذكر حجم app.js إلى **"حوالي 8,340 سطر"** (بعد فصل الوحدات).

**معيار الإنجاز:** من يفتح التقرير ويذهب للملفات المشار إليها يجد الأسطر والأسماء مطابقة للكود.

---

## 4. ملف .env.example (توثيق للمفتاح والإيميلات)

**المطلوب تنفيذه:**

1. إنشاء ملف **`app/.env.example`** (بدون قيم حقيقية) يوضح للمطور/الناشر أي متغيرات بيئة يُفضّل استخدامها في الإنتاج، مثل:
   - `VITE_ADMIN_SECRET_KEY=`
   - `VITE_ADMIN_ALLOWED_EMAILS=`
   - ولو أردت: `VITE_FIREBASE_API_KEY=` وغيرها من إعداد Firebase إن كان سيتم حقنها من env.
2. التأكد أن `.env` و `.env.local` في `.gitignore` حتى لا تُرفع أسرار. إن لم تكونا موجودتين، إضافتهما.
3. إضافة سطر في `SECURITY.md` أو `README` يشير إلى `.env.example` ويقول إن نسخه إلى `.env` وملء القيم مطلوب قبل النشر الحقيقي.

**معيار الإنجاز:** وجود `.env.example` وعدم رفع `.env` إلى الريبو، مع إشارة في الوثائق.

---

## 5. Checklist التنفيذ (تسليمك)

بعد تنفيذ البنود 1–9، أضف أو حدّث ملف **`app/docs/DELIVERY-AND-AUDIT.md`** (أو TANFIZ-DONE) يحتوي على:

- قائمة البنود من 1 إلى 9 مع الحالة ("تم" أو "لم يُنفَّذ" + السبب).
- أمام كل بند تم: جملة واحدة عن ما تم (مثلاً: "تم إنشاء scripts/inject-firebase-config.js وربط الملفات الخمسة به").
- قسم "مطلوب من صاحب المشروع (يدوياً)" للبنود اللي تحتاج إجراء خارج الكود.

---

## 6. فصل app.js إلى وحدات (إصلاح كبير)

**المشكلة:** `Rewards/src/app.js` فيه آلاف الأسطر — صعوبة صيانة واحتمال أخطاء scope. التقرير يوصي بتقسيم إلى وحدات.

**المطلوب تنفيذه:**

1. تقسيم **`app/Rewards/src/app.js`** إلى ملفات/وحدات منطقية بحيث يبقى **نفس السلوك بالكامل** (لا تغيير في الوظائف ولا كسر للواجهة). أمثلة تجميع (يمكن تعديل الأسماء حسب ما يناسب):
   - **firebase-io.js** (أو rewards-firebase.js): تهيئة Firebase، جلب/رفع الفترة، `fetchLivePeriodFromFirebase`, `fetchPeriodFromFirebase`, `applyLivePeriod`, `doSyncLivePeriodNow`, `doSyncLivePeriodToFirebase`، وأي دوال مرتبطة بالقراءة/الكتابة من Firebase.
   - **rbac.js** (أو rewards-rbac.js): التحقق من الأدوار، `validateAdminAccess`, `tryValidateAdminAccessFromFirebase`, `isAdminMode`, `isAdminLinkSubmitted`, `initializeRoleBasedUI`, `hideElementsFor*`، وأي منطق مرتبط بالصلاحيات والترويسة.
   - **table-render.js** (أو rewards-table.js): دوال بناء الجدول والعناصر الديناميكية (أعمدة، صفوف، تقييمات، خصومات) التي لا تعتمد على Firebase مباشرة.
   - **app.js** يبقى نقطة الدخول: يضمّن الوحدات (عبر script tags أو بناء يجمّعهم)، ويحتفظ بتهيئة الصفحة وربط الأحداث والـ state المشترك (db، branches، إلخ) بحيث الوحدات تقرأ/تكتب من نفس المتغيرات العالمية أو من كائن مشترك.
2. التأكد أن **`npm run sync:rewards`** و **`npm run build`** يعملان بعد التقسيم، وأن صفحة المكافآت تعمل بنفس السلوك (رفع، تحميل من Firebase، أدوار، أزرار، إرسال مشرف/HR).
3. توثيق في **README** أو داخل `Rewards/` يشرح هيكل الملفات الجديد (من يقرأ من مين، ترتيب التحميل إن لزم).

**معيار الإنجاز:** app.js مقسّم إلى عدة ملفات؛ البناء والسينك ناجحان؛ لا فرق في سلوك التطبيق من وجهة نظر المستخدم.

---

## 7. استبدال أو تأمين حزمة xlsx (إصلاح كبير)

**المشكلة:** حزمة xlsx بها ثغرات (Prototype Pollution، ReDoS). تقييد المدخلات (البند 2) يقلل الخطر لكن لا يزيله.

**المطلوب تنفيذه (اختر أحد الخيارين أو نفّذ الأقوى ممكن):**

- **الخيار أ — استبدال الحزمة:** تقييم واستبدال `xlsx` بالحزمة الرسمية **SheetJS** (مثلاً `@sheetjs/core` أو الإصدار الرسمي الموثّق من sheetjs.com) إن كان متوافقاً مع طريقة الاستخدام الحالية (قراءة صفوف، دمج، إلخ). بعد الاستبدال: تشغيل التحليل ورفع ملفات فعلية والتأكد أن النتائج لا تختلف. توثيق في README أو في الكود اسم الحزمة الجديدة وإصدارها.
- **الخيار ب — إن لم يكن الاستبدال ممكناً بدون كسر:** إضافة طبقة تحقق إضافية قبل استدعاء xlsx: مثلاً التحقق من أن الـ buffer لا يتجاوز حجماً معقولاً، وأن الـ MIME/امتداد صحيح، و(إن أمكن) قراءة أول بايتات والتحقق من توقيع ملف xlsx معروف. توثيق في CODE_REVIEW_REPORT أو في التعليقات أن الحزمة الحالية معروفة الثغرات وأن الخيار أ مُوصى به عند توفر وقت.
- في **كل الأحوال:** الإبقاء على تقييد الحجم والنوع (البند 2) وعدم إزالته.

**معيار الإنجاز:** إما استبدال xlsx بحزمة رسمية آمنة مع نفس السلوك، أو تحقق إضافي + توثيق واضح للخطر والتوصية.

---

## 8. توحيد قائمة مسح الجلسة في clear-session (إصلاح متوسط)

**المشكلة:** في `public/clear-session.html` قائمة المفاتيح المُمسحة مكررة: مرة في `clearSessionAndAnalysisOnly` ومرة في الـ catch. لو تمت إضافة مفتاح جديد يُنسى في أحد الموضعين.

**المطلوب تنفيذه:**

1. جعل قائمة المفاتيح **في مكان واحد فقط** داخل السكربت: مثلاً مصفوفة `var keysToRemove = ['adora_admin_auth_session', 'adora_current_role', ...]` ثم دالة واحدة تمسح كل عنصر في المصفوفة.
2. استدعاء نفس الدالة من المسار العادي (بعد signOut) ومن الـ catch (عند الفشل) حتى لا يتكرر النص.
3. التعليق في الكود يوضح أن أي مفتاح جديد يُضاف في المصفوفة فقط.

**معيار الإنجاز:** تعديل مفتاح واحد (إضافة أو حذف) يتم في مكان واحد فقط في clear-session.html.

---

## 9. سكربت تحقق قبل النشر (إصلاح متوسط)

**المشكلة:** لا يوجد تحقق آلي يمنع النشر بأسرار مكشوفة أو إعداد خاطئ.

**المطلوب تنفيذه:**

1. إنشاء سكربت **`app/scripts/pre-deploy-check.js`** (أو تحديثه إن وُجد) يعمل مع **Node** ويقوم بما يلي (بدون تنفيذ أي أمر نشر فعلي):
   - التحقق من وجود ملف **`.env`** في مجلد `app` عند الرغبة في النشر "آمن" (مثلاً إذا كان المتغير `CHECK_SECRETS=1` أو إذا الملف غير موجود يطبع تحذير فقط).
   - التحقق من أن **`shared/firebase-config.json`** (أو المصدر الواحد) لا يحتوي على قيم واضحة للتطوير فقط (مثلاً تحذير إذا apiKey يبدأ بقيمة معينة معروفة من الوثائق).
   - (اختياري) التحقق من أن **`adminConfig.ts`** أو الملف المولَّد لا يحتويان على المفتاح الافتراضي `ayman5255` إذا كان الهدف "إنتاج" — أو يطبع تذكير بأن تغيير المفتاح مطلوب قبل النشر الحقيقي.
   - يطبع نتيجة واضحة: "التحقق نجح" أو "تحذير: ..." مع الخروج بكود 0 أو 1 حسب السياسة (مثلاً تحذير فقط = 0، فشل صريح = 1).
2. إضافة أمر في **package.json** مثل `"pre-deploy-check": "node scripts/pre-deploy-check.js"` وتوثيق في **PRE-DEPLOY-STEPS.md** أو **README** أن تشغيل هذا الأمر مطلوب قبل `npm run deploy` (أو يدوياً قبل الرفع).

**معيار الإنجاز:** تشغيل السكربت يطبع تحذيرات أو أخطاء واضحة عند وجود أسرار افتراضية أو غياب .env؛ الوثائق تشير إلى تشغيله قبل النشر.

---

**ملاحظات:**

- البنود 6–9 إصلاحات كبيرة/متوسطة وتستهلك وقتاً — مطلوبة ضمن نطاق العمل لأن التسليم يشمل تحسينات فعلية وليس تقارير فقط.
- البنود اللي تحتاج إجراء **يدوي من صاحب المشروع** (مثل تقييد API key في Google Cloud Console) تُذكر في DELIVERY-AND-AUDIT.md تحت "مطلوب من صاحب المشروع".
- الهدف: **تسليم مشروع بعد التنفيذ** فيه إصلاحات ملموسة (كود، وحدات، أمان، توثيق)، وليس تقريراً إضافياً فقط.
