# التقييمات والحضور و«بطل تحدي الظروف» — هل تُخزَّن في Firebase؟

## الخلاصة السريعة

| البيانات | مصدر الإدخال | هل تُخزَّن في Firebase؟ | متى تظهر في المكافآت؟ |
|----------|---------------|-------------------------|------------------------|
| **التقييمات** (Booking / Google) | يُدخلها **المشرف** من صفحة المكافآت | ✅ نعم — داخل ملف الفترة (`periods/live.json` أو `periods/YYYY_MM.json`) | بعد أن يدخلها المشرف ثم تتم المزامنة، أو بعد ضغط «تحميل التحديثات» |
| **الحضور** (أيام الحضور / 26 يوم) | يُدخلها **HR أو الإداري** من صفحة المكافآت | ✅ نعم — نفس الملف | نفس ما سبق |
| **بطل تحدي الظروف** (26 يوم وأكثر) | ناتج من **أيام الحضور** المُدخلة في المكافآت | ✅ نعم — الحقل `attendance26Days` في كل موظف | يظهر تلقائياً عند وجود 26 يوم حضور أو أكثر |

---

## من أين تأتي البيانات؟

### 1. نظام التحليل (Analysis) **لا يرسل** تقييمات ولا حضور

عند النقر على «الانتقال إلى حساب المكافآت» من صفحة التحليل، الـ payload الذي يُنقل يحتوي فقط على:

- أسماء الموظفين والفروع
- أعداد الحجوزات والشفتات و VIP والتنبيهات
- الإعدادات (الفروع، أسعار المكافآت، إلخ)

**لا يُضمَّن في النقل:**

- `evaluationsBooking` / `evaluationsGoogle`
- `attendanceDaysPerBranch` / `totalAttendanceDays` / `attendance26Days`

لأن نظام التحليل لا يجمع هذه البيانات أصلاً؛ مصدرها هو **صفحة المكافآت** (إدخال المشرف/HR).

### 2. أين تُخزَّن في Firebase؟

- **النوع:** Firebase **Storage** (ملفات JSON)، وليس Realtime Database أو Firestore.
- **المسارات:**
  - `periods/live.json` — الفترة «الحية» الحالية (آخر نسخة محدثة).
  - `periods/YYYY_MM.json` — نسخة ثابتة للفترة (مثلاً `2026_01.json`).

كل ملف فترة يحتوي على كائن واحد فيه على الأقل:

- `db`: مصفوفة الموظفين، وكل عنصر فيها يمكن أن يحتوي على:
  - `evaluationsBooking`, `evaluationsGoogle`
  - `attendanceDaysPerBranch`, `totalAttendanceDays`, `attendance26Days`
- `negativeRatingsCount`, `discounts`, `discountTypes`, إلخ.

هذه الحقول **موجودة في البنية** التي تكتبها صفحة المكافآت عند المزامنة؛ إذا لم يُدخلها أحد تبقى قيمها 0 أو `false` أو `{}`.

### 3. متى تُكتَب إلى Firebase؟

التقييمات والحضور (وبالتالي «بطل تحدي الظروف») تُكتَب إلى Firebase **فقط** عندما:

1. **أحد يدخلها من صفحة المكافآت** (المشرف يملأ التقييمات، HR يملأ أيام الحضور)، **و**
2. تحدث مزامنة مع Firebase، إما:
   - تلقائياً (مثلاً بعد تعديل في الجدول يُفعّل `syncLivePeriodToFirebase`)، أو
   - عند إغلاق الفترة، أو
   - عند الضغط على «تحميل التحديثات» (الذي يقرأ من Firebase ثم قد يُعيد الكتابة لاحقاً حسب المنطق).

أول مرة تفتح فيها المكافآت بعد «نقل» من التحليل: يتم رفع الفترة إلى Firebase بدون تقييمات/حضور (قيم افتراضية)، لذلك **الملف الموجود في Firebase قد لا يحتوي بعد على أي تقييمات أو حضور حقيقي**.

---

## لماذا قد «لا تُجلب» أو «لا تظهر» في المكافآت؟

1. **لا يوجد ملف فترة في Firebase أصلاً**  
   (لم يسبق أن تم نقل للمكافآت أو رفع فترة لهذا الشهر) → لا شيء يُجلب.

2. **الملف موجود لكن بدون إدخال من المشرف/HR**  
   التقييمات والحضور في الملف = 0 أو false → المكافآت تعرض أصفار/بدون بطل تحدي الظروف حتى لو «جلب» البيانات.

3. **لم يضغط أحد «تحميل التحديثات»**  
   حتى لو المشرف أدخل البيانات من جهاز آخر وتمت المزامنة إلى Firebase، جهازك لن يرى التحديث إلا بعد «تحميل التحديثات» (أو إعادة فتح الصفحة مع منطق الجلب التلقائي).

4. **مشكلة في Firebase (صلاحيات، شبكة، إعداد المشروع)**  
   إن فشل جلب `periods/live.json` أو `periods/YYYY_MM.json` فلن تظهر أي بيانات محفوظة هناك.

---

## ماذا تفعل عملياً؟

- **لتأكيد أن التقييمات/الحضور مخزنة في Firebase:**  
  افتح Firebase Console → Storage → المسار `periods/` وتحقق من وجود `live.json` أو `YYYY_MM.json`، ثم افتح الملف وتأكد من وجود الحقول `evaluationsBooking`, `evaluationsGoogle`, `attendanceDaysPerBranch`, `attendance26Days` وقيمها في مصفوفة `db`.

- **لجعل التقييمات والحضور تظهر في المكافآت:**  
  1) إدخالها من صفحة المكافآت (المشرف/HR).  
  2) الانتظار حتى تتم المزامنة أو إغلاق الفترة.  
  3) على الأجهزة الأخرى: الضغط على «تحميل التحديثات» (أو إعادة تحميل الصفحة حسب التدفق المعتمد).

---

*ملف مرجعي — تم استنتاجه من: `app/src/App.tsx` (نقل التحليل)، `app/Rewards/src/rewards-firebase.js` (قراءة/كتابة Firebase)، `app/Rewards/src/app.js` (دمج البيانات وعرضها).*
