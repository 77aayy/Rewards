# برومبت مراجعة المشروع — مراجعة كاملة ودقيقة

**الغرض:** مبرمج هيستلم المشروع ويراجعه مراجعة شاملة قبل التسليم. المطلوب مراجعة ليلية دقيقة تخرج المشروع في صورة متكاملة مع تقرير واضح عن كل نقاط الضعف والإصلاحات المطلوبة.

**مهمتك:** تقرأ المشروع كله، تفهم الهيكل والتدفقات، وتراجع الأمان والهندسة والجودة. في النهاية تطلع تقريراً منظماً (مرتب حسب الأولوية وخطورة المشاكل) مع توصيات تنفيذية. لا تكتفي بقراءة سريعة — المفروض المراجعة تاخد وقت (ليلة عمل) وتغطي كل الملفات الحرجة والتدفقات الحرجة.

---

## 1. فهم المشروع (اقرأ الأول)

المشروع عبارة عن **تطبيق ويب واحد** فيه جزءين:

- **التحليل (Analysis):** تطبيق React (في `app/src/`) — رفع ملفات إكسل (حجوزات، موظفين)، تحليل بيانات، وعرض نتائج. الأدمن يسجّل دخول (إيميل + باسورد عبر Firebase Auth، أو مفتاح سري في الـ URL). من التحليل يقدر يعمل "نقل لصفحة المكافآت" فيحفظ payload في localStorage ويوجّه إلى `/rewards/?transfer=1`.
- **المكافآت (Rewards):** تطبيق Vanilla JS (المصدر في `app/Rewards/`، والنسخة المُخدمة في `app/public/rewards/` بعد `npm run sync:rewards`). إدارة فترة مكافآت: جدول موظفين، فروع، تقييمات، خصومات. الأدمن يرفع/يحمّل الفترة من Firebase؛ المشرف و HR يدخلون بياناتهم عبر روابط خاصة (role + token + period) ويرسلون لـ Firebase. المحاسبة والمدير للعرض فقط. بعد إرسال المشرف/HR لا يُسمح بإدخال نفس البيانات مرة ثانية (حالة الإرسال محفوظة في Firebase).

الهيكل المهم:
- **مصدر المكافآت:** `app/Rewards/` فقط. `app/public/rewards/` ناتج سكربت — لا تعديل يدوي فيه.
- **الإعداد المشترك:** أزرار الترويسة من `app/shared/headerButtonsConfig.json`؛ إعداد Firebase مكرر في عدة ملفات (يجب أن تتطابق).
- **النشر:** Firebase Hosting؛ الـ build من `app` (Vite يبني React ويضع معه محتويات `public/` بما فيها `rewards/`).

الوثائق اللي لازم تراجعها:
- `app/README.md` — نظرة عامة
- `app/Rewards/SECURITY.md` — مفتاح الأدمن، إعداد Firebase، قواعد Storage
- `app/Rewards/ARCHITECTURE.md` — بروتوكول الهندسة والأمان
- `app/docs/CLEANUP.md` — هيكل المشروع وما يُحذف
- `app/PRE-DEPLOY-STEPS.md` — خطوات قبل الرفع (تقييد API key)
- `app/docs/DEV-SETUP.md` — تشغيل محلي

---

## 2. نطاق المراجعة المطلوب

راجع كل ما يلي بدقة. لا تتخطى بند.

### 2.1 الأمان (Security)

- **مفتاح الأدمن:** موجود في `app/src/adminConfig.ts` و `app/Rewards/src/app.js`. هل القيمتان متطابقتان؟ هل المفتاح أو الإيميلات مكشوفة في أماكن تانية (تعليقات، لوجات، query params مخزنة)؟
- **Firebase:** إعداد الـ API key مكرر في: `adminConfig.ts`، `firebase.ts`، `clear-session.html`، `Rewards/src/firebase-config.js`. هل كل النسخ متطابقة؟ هل في أي مكان بيستخدم إعداد مختلف؟
- **قواعد Firebase Storage:** اقرأ `storage.rules`. القراءة والكتابة/الحذف حالياً مفتوحة (الاعتماد على روابط سرية). وثّق المخاطر واقترح تحسينات لو أمكن بدون backend.
- **أسرار في الكود:** ابحث في كل المشروع عن أي API keys، tokens، كلمات سر، إيميلات حساسة مكتوبة نصاً. راجع أيضاً `app-extensions.js` وملفات الإعداد.
- **التحقق من الصلاحيات:** عند فتح رابط مشرف/HR، هل التحقق من الـ token/period يتم بشكل آمن؟ هل في ثغرات تسمح بتجاوز الدور (مثلاً عرض أدمن من رابط مشرف)؟
- **بيانات المستخدم:** هل أي بيانات شخصية أو مالية تُرسل بدون حماية أو تُخزن في مكان غير آمن؟

### 2.2 الهندسة والهيكل (Architecture)

- **مصدر واحد للمكافآت:** هل كل التعديلات على المكافآت تتم في `Rewards/` فقط وهل السينك (`sync:rewards`) كافي؟ هل في ملفات في `public/rewards` مختلفة عن `Rewards` بدون سبب؟
- **التكرار (Duplication):** إعداد Firebase، مفتاح الأدمن، مفاتيح localStorage (مثلاً أسعار المكافآت) — هل في تكرار يسبب خطر تناقض؟ هل في constants مشتركة ممكن توحيدها؟
- **تدفق البيانات:** من التحليل إلى المكافآت (transfer payload في localStorage ثم redirect). من المشرف/HR إلى Firebase (رفع مع adminSubmitted). من Firebase إلى الواجهة (applyLivePeriod، جلب الفترة الحية). ارسم أو اشرح التدفق وحدد أي نقطة ضعف (مثلاً فقدان بيانات، حالة غير متسقة).
- **localStorage:** وثّق كل المفاتيح المستخدمة (adora_*) وأيها مصدر حقيقة وأيها كاش. هل في اعتماد زائد على localStorage لأدوار المفروض تكون مرتبطة بـ Firebase فقط؟

### 2.3 الجودة والصيانة (Code Quality)

- **TypeScript و React:** في `app/src/` هل في استخدام `any`؟ هل الـ types متسقة؟ هل في أخطاء ESLint أو TypeScript مهملة؟
- **معالجة الأخطاء:** هل الـ try/catch والرسائل للمستخدم كافية في المسارات الحرجة (رفع ملف، إرسال للمشرف، مزامنة Firebase)؟
- **التنظيف (Cleanup):** هل في listeners أو timers أو subscriptions (مثلاً في useEffect أو في app.js) بدون cleanup يسبب تسريب ذاكرة؟
- **الأداء:** هل في عمليات ثقيلة على الواجهة (مثلاً جداول ضخمة بدون virtualisation)؟ هل الـ re-renders في React محسّنة حيث يلزم؟
- **التوافق مع المتصفحات:** هل في استخدام APIs غير مدعومة في المتصفحات المستهدفة بدون fallback؟

### 2.4 الوظائف والسيناريوهات (Functional)

- **تسجيل الدخول:** أدمن بالمفتاح، أدمن بالإيميل/باسورد، روابط الإداريين (supervisor, hr, accounting, manager). اختبر أو راجع الكود لكل مسار.
- **التحليل:** رفع ملف، تحليل، نقل للمكافآت. هل الـ payload المُنقل كامل وما ينقصش؟
- **المكافآت:** رفع فترة، تحميل من Firebase، إدخال المشرف/HR، إرسال (مع منع إدخال ثاني)، إغلاق الفترة، خروج الأدمن. هل حالة "تم الإرسال" (adminSubmitted) محفوظة ومقروءة من Firebase بشكل صحيح على أي جهاز؟
- **أزرار الترويسة:** صلاحيات الأزرار حسب الدور (أدمن يرى كل الأزرار؛ مشرف/HR/mحاسبة/مدير يرون زر "شروط المكافآت" فقط). راجع تطبيق هذا المنطق في المكافآت والتحليل.
- **صفحة مسح الجلسة:** `clear-session.html` — هل تمسح كل المفاتيح المطلوبة وتوجّه بشكل صحيح؟

### 2.5 النشر والتشغيل (Deploy & Run)

- **سكربتات البناء والنشر:** `npm run build`، `npm run sync:rewards`، `npm run deploy`. هل تعمل بدون أخطاء؟ هل الـ rewrites في `firebase.json` صحيحة؟
- **الوثائق:** هل README و SECURITY و PRE-DEPLOY-STEPS و DEV-SETUP كافية لمبرمج جديد يشغّل المشروع وينشره بأمان؟
- **التبعيات:** هل `package.json` ونسخ الحزم محدثة وآمنة (لا ثغرات معروفة في التبعيات المستخدمة)؟

---

## 3. نقاط ضعف معروفة (تأكد منها وراجعها)

هذه نقاط سبق تحديدها — المطلوب التأكد من حالتها الحالية وإدراجها في التقرير مع باقي النتائج:

1. **مفتاح الأدمن وإيميلات الأدمن مكتوبين في الكود** — مقصود حالياً لعدم إيقاف المشروع؛ يجب توثيق أن التغيير ضروري قبل النشر الحقيقي.
2. **إعداد Firebase مكرر في 4+ ملفات** — أي تغيير يحتاج تحديث يدوي في كل المواضع؛ خطر تناقض.
3. **قواعد Firebase Storage مفتوحة (قراءة وكتابة/حذف)** — الاعتماد على "روابط سرية" فقط؛ لا Rate Limiting ولا تحقق من الهوية من جانب السيرفر.
4. **لا يوجد backend مخصص** — كل العمليات الحساسة من العميل إلى Firebase مباشرة.
5. **ملف المكافآت app.js كبير جداً (آلاف الأسطر)** — صعوبة صيانة؛ احتمال تكرار منطق أو أخطاء scope.
6. **اعتماد كبير على localStorage** للجداول والفترة والأدوار — مصدر الحقيقة لبعض الأشياء Firebase لكن الواجهة تقرأ من localStorage بعد التطبيق.

---

## 4. مخرجات مطلوبة منك (تقرير المراجعة)

يجب أن يخرج تقريرك في شكل واضح وقابل للتسليم. استخدم الملف التالي كقالب (أنشئ ملفاً باسم `CODE_REVIEW_REPORT.md` في مجلد `app/docs/` أو في جذر المشروع).

### هيكل التقرير

1. **ملخص تنفيذي (نص قصير):**  
   حالة المشروع بشكل عام، هل جاهز للإنتاج من ناحية أمان وجودة، وأهم 3–5 إجراءات مطلوبة.

2. **جدول بالمشاكل والتوصيات:**  
   لكل بند:
   - **البند:** عنوان قصير.
   - **الموقع:** الملف(ات) ورقم السطر إن أمكن.
   - **الخطورة:** عالية / متوسطة / منخفضة.
   - **الوصف:** ما المشكلة بالضبط.
   - **التوصية:** ماذا تفعل للإصلاح (خطوات تنفيذية إن أمكن).

3. **أقسام مفصلة (اختياري لكن مُفضّل):**
   - الأمان
   - الهندسة والهيكل
   - الجودة والصيانة
   - الوظائف والسيناريوهات
   - النشر والوثائق

4. **Checklist جاهزية الإنتاج:**  
   قائمة (نعم/لا) تشمل مثلاً: تغيير مفتاح الأدمن، تقييد API key، تطابق إعداد Firebase، عدم وجود أسرار في الكود، توثيق خطوات النشر، إلخ.

5. **ملحق (إن وجد):**  
   أي اقتراحات لتحسينات لاحقة (مثلاً فصل app.js، إدخال مصدر واحد لـ Firebase config، إضافة Rate Limiting لاحقاً).

---

## 5. تعليمات التنفيذ

- ابدأ بقراءة الوثائق (القسم 1) ثم الهيكل في الريبو (CLEANUP، هيكل المجلدات).
- نفّذ المراجعة حسب الأقسام في 2.1–2.5. لا تتخطى أي قسم.
- استخدم البحث في الملفات (grep، بحث نصي) للتأكد من كل مواضع المفتاح والإعداد والـ localStorage.
- شغّل المشروع محلياً (`npm run dev` من `app`) وتأكد أن التحليل والمكافآت يعملان؛ جرّب سيناريوهات الأدمن والمشرف ومسح الجلسة.
- املأ التقرير بالهيكل المطلوب في القسم 4. رتّب المشاكل حسب الخطورة (عالية أولاً).
- الهدف: مراجعة ليلية واحدة تخرج مشروعاً موثّقاً وتقريراً يوضح كل نقاط الضعف والإصلاحات المطلوبة حتى يكون التسليم واضحاً ومتكاملاً.

---

**باختصار:** افهم المشروع كامل، راجع الأمان والهندسة والجودة والوظائف والنشر، تأكد من النقاط المعروفة، واطلع تقريراً منظماً (ملخص + جدول مشاكل بتوصيات + checklist جاهزية). المراجعة مفترض تكون دقيقة وتاخد وقت كافٍ (ليلة عمل) عشان المبلغ المدفوع يستحق.
