rules_version = '2';
// قرار القراءة/الكتابة (توثيق — راجع ARCHITECTURE.md):
// - القراءة مفتوحة (allow read: if true) عن قصد: التطبيق لا يستخدم Firebase Auth؛
//   الوصول يُتحقق منه عبر روابط سرية (admin key، role+token+period، كود موظف).
// - عند إضافة Auth لاحقاً يُفضّل تضييق القراءة (مثلاً حسب request.auth != null أو صلاحيات محددة).
// تقييد الكتابة: حجم ≤ 5MB ونوع application/json فقط (التطبيق يرفع JSON فقط).
// الكتابة غير مربوطة بهوية الطالب حالياً؛ يمكن ربطها بصلاحيات عند وجود Auth.
//
// مسارات periods/: live.json (آخر نسخة حية)، 2026_01.json (نسخة ثابتة للفترة)
// المشرف و HR يستدعيان من periods/{periodId}.json على أجهزة جديدة — يجب أن تسمح القواعد بالقراءة.
service firebase.storage {
  match /b/{bucket}/o {
    // periods/: للفترات المغلقة (live.json، 2026_01.json، ...). الحذف لا يرسل request.resource فيجب السماح به صراحة.
    match /periods/{periodId} {
      allow read: if true;
      allow create, update: if request.resource.size < 5 * 1024 * 1024
                             && request.resource.contentType == 'application/json';
      allow delete: if true;
    }
    match /admin_tokens/{periodId} {
      allow read: if true;
      allow create, update: if request.resource.size < 5 * 1024 * 1024
                             && request.resource.contentType == 'application/json';
      allow delete: if true;
    }
    // config/: الرصيد التراكمي (cumulativePoints.json) — مصدر واحد من أي جهاز
    match /config/{fileId} {
      allow read: if true;
      allow create, update: if request.resource.size < 5 * 1024 * 1024
                             && request.resource.contentType == 'application/json';
      allow delete: if true;
    }
  }
}
