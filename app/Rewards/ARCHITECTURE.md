# بروتوكول الهندسة المعمارية والأمان — مشروع إليت / Rewards

هذا الملف يوثق البروتوكول المعماري الذي يُطبَّق على كل ميزة جديدة في المشروع.

---

## 1. سلسلة التأثير (Impact Chain)

**القاعدة:** لا تنفّذ ميزة واجهة بمفردها. لكل طلب (زر، نموذج، إلخ) يجب ربط الدورة الكاملة.

| الخطوة | الوصف |
|--------|--------|
| **1. المحفّز (Frontend)** | من يفعل؟ ما المدخل؟ تحقق صارم من العميل. |
| **2. الاستمرارية (Backend/DB)** | أين تذهب البيانات؟ الـ Schema؟ تدفق الحالة (pending/approved)؟ |
| **3. العاقبة (المستلم/الأدمن)** | من يجب أن يرد؟ لوحة الأدمن، إشعارات. لا تترك بيانات "يتيمة" في DB بدون من يعرضها أو يعالجها. |
| **4. التغذية الراجعة** | كيف يعرف المستخدم أن العملية نجحت؟ Toasts، تحديث الواجهة. |

---

## 2. معيار "عدم الثقة" (Zero Trust)

1. **التحقق من المدخلات:** تحقق صارم (مثلاً Zod) على العميل والسيرفر. لا تثق بـ `req.body` كما هو.
2. **عزل المنطق:** المنطق الحساس (مدفوعات، صلاحيات، تغيير حالة) يكون في الـ Backend فقط.
3. **التحكم في الوصول:** تحديد صريح لمن يقرأ/يكتب. لا `allow read, write: if true`.
4. **الدفاع:** Rate Limiting لأفعال حساسة (تسجيل دخول، كتابة).

### Rate Limiting (توثيق — خطة مستقبلية)
- **الحالة الحالية:** التطبيق يعمل بدون backend مخصص؛ عمليات حساسة (إرسال المشرف/HR، إغلاق الفترة، رفع الملف) تتم من العميل مباشرة إلى Firebase.
- **المخاطر:** إمكانية إساءة استخدام (طلبات متكررة سريعة) في حال معرفة الروابط أو المفتاح.
- **الخطة:** عند إضافة Cloud Functions أو backend مخصص، يُفضّل إضافة حد لمعدل الطلبات (Rate Limiting) على الإجراءات الحساسة: إغلاق الفترة، رفع/تحديث الفترة الحية، إنشاء روابط إداريين. يمكن استخدام Firebase App Check + Cloud Functions لفرض حدود (مثلاً N طلب/دقيقة لكل مصدر).
- **مرجع:** راجع `storage.rules` و `CODE_REVIEW_REPORT.md` لقرارات القراءة/الكتابة الحالية.

---

## 3. أسلوب الكود والجودة

- هندسة modular: فصل UI عن Logic.
- عدم وضع أسرار في الكود؛ استخدام `.env`.
- معالجة أخطاء منظمة (واجهة + سجلات).

---

## 4. تنسيق الرد عند طلب ميزة

قبل كتابة أي كود، يجب إخراج **الخطة المعمارية** بهذا الشكل:

1. **Full Lifecycle:** [User View] ➡️ [DB Schema] ➡️ [Receiver/Admin View] ➡️ [Feedback]
2. **Security Measures:** التحقق، الصلاحيات، القواعد.
3. **Files to Modify:** قائمة الملفات.

بعد ذلك فقط يُكتَب الكود وفق الخطة.
